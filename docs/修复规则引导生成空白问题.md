# 修复规则引导生成空白问题

## 问题描述

运行混合系统时，**规则引导Prompt策略32次全部生成空字符串**：

```
策略效果分析：
┏━━━━━━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━┓
┃ 策略 ┃ 使用次数 ┃ 正确次数 ┃ 准确率 ┃
┡━━━━━━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━┩
│ 规则直接应用 │ 18 │ 9 │ 50.0% │
│ 规则引导Prompt │ 32 │ 0 │ 0.0% │ ← 全部失败！
│ LLM兜底 │ 1 │ 0 │ 0.0% │
└────────────────┴──────────┴──────────┴────────┘

失败案例：
 旧代码: input.cuda()
 生成: （空）
 期望: input.to('cuda')
 策略: rule_guided
```

---

## 根本原因

### 原因1：Fallback逻辑错误
```python
# 旧代码（错误）
def _generate_with_rule_guidance(self, old_code, rule, description):
 # 试图创建新的RuleMatcher → 失败
 try:
 from rule_matcher import RuleMatcher
 matcher = RuleMatcher([rule], confidence_threshold=0.5)
 direct_result = matcher.apply_rules(old_code, [(rule, 1.0)])
 ...
 except:
 pass # 静默失败
```

### 原因2：LLM生成重复字符后被过度过滤
```python
# 旧代码（过严）
if diversity < 0.3: # 30%的阈值太高
 console.print(f"检测到低多样性输出，跳过: {line}")
 continue

# 最后返回空字符串
return "" # ← 导致规则引导失败
```

### 原因3：数据生成脚本bug
```python
# 旧代码（错误）
func_patterns = [
 ("sigmoid", "sigmoid"), # 元组
 ...
]
for func in func_patterns:
 f"torch.nn.functional.{func}(x)" # 插入元组！
 # 生成: torch.nn.functional.('sigmoid', 'sigmoid')(x)
```

---

## 解决方案

### 修复1：改进规则引导逻辑

**文件**: `server_scripts/hybrid_generator.py`

```python
# 新代码（正确）
def _generate_with_rule_guidance(self, old_code, rule, description):
 """先尝试直接应用规则，失败则用LLM，最后返回原代码"""
 
 # 1. 先用当前matcher直接应用规则
 try:
 direct_result = self.matcher.apply_rules(old_code, [(rule, 1.0)])
 if direct_result and direct_result != old_code:
 return direct_result
 except Exception as e:
 console.print(f"[dim]规则应用失败: {e}[/dim]")
 
 # 2. 规则无法应用，使用简化的LLM prompt
 if rule['type'] == 'api_replacement':
 prompt = f"""{old_code}
Replace {rule['old_api']} with {rule['new_api']}:"""
 else:
 # 参数迁移等复杂类型直接返回原代码
 return old_code
 
 # 3. LLM生成
 generated = self._llm_generate(prompt, max_new_tokens=50)
 
 # 4. 如果生成失败，返回原代码（而不是空字符串）
 if not generated or generated.strip() == "":
 return old_code
 
 return generated
```

---

### 修复2：放宽LLM生成的多样性检测

**文件**: `server_scripts/hybrid_generator.py`

```python
# 新代码（放宽）
def _llm_generate(self, prompt, max_new_tokens=80):
 # 使用更温和的生成参数
 outputs = self.model.generate(
 **inputs,
 max_new_tokens=max_new_tokens,
 do_sample=True, # 使用采样
 temperature=0.3, # 低温度
 top_p=0.9,
 repetition_penalty=1.2, # 适度防重复
 no_repeat_ngram_size=3
 )
 
 # 只过滤极端情况
 if len(line) > 15:
 diversity = unique_chars / total_chars
 
 # 放宽到20%（原30%太严）
 if diversity < 0.2:
 continue
 
 # 过多特殊字符
 if line.count('!') > 5 or line.count('?') > 5:
 continue
 
 # 返回生成的代码
 return code_lines[0] if code_lines else ""
```

---

### 修复3：修正数据生成脚本

**文件**: `server_scripts/fetch_public_dataset.py`

```python
# 旧代码
func_patterns = [("sigmoid", "sigmoid"), ...]
for func in func_patterns: # func是元组
 f"torch.nn.functional.{func}(x)" # 错误

# 新代码
func_names = ["sigmoid", "tanh", "relu", "softmax"]
for func in func_names: # func是字符串
 f"torch.nn.functional.{func}(x)" # 正确
```

---

## 验证修复

### 步骤1：重新生成数据集

```bash
cd ~/api_migration_exp/scripts

# 重新生成公开数据集（修复PyTorch bug）
python3 fetch_public_dataset.py
```

### 步骤2：快速测试

```bash
# 测试规则引导生成是否正常
python3 test_rule_guided.py
```

**预期输出**：
```
测试规则引导生成

 加载了 XX 条规则

测试案例：

案例 1:
 旧代码: input.cuda()
 期望: input.to('cuda')
 生成: input.to('cuda')
 策略: rule_direct
 置信度: 0.95
 精确匹配

案例 2:
 旧代码: df.append(row)
 期望: pd.concat([df, row])
 生成: pd.concat([df, row])
 策略: rule_direct
 置信度: 0.90
 精确匹配
```

### 步骤3：完整运行

```bash
# 删除旧规则
rm ../configs/learned_rules.json

# 运行完整混合系统
python3 run_hybrid_system_fixed.py public_dataset.json
```

---

## 预期改进

```diff
修复前（规则引导全部失败）:
- 规则引导Prompt: 32次使用，0次正确，0.0%准确率
- 精确匹配率: 17.6%
- 平均相似度: 0.330

修复后（规则引导正常工作）:
+ 规则引导Prompt: 应该能生成有效代码
+ 规则引导准确率: 预期40-60%
+ 精确匹配率: 预期提升到40-55%
+ 平均相似度: 预期提升到0.55-0.70
```

---

## 关键改进点

1. **智能Fallback** 
 - 规则应用失败 → 简化LLM prompt → 返回原代码
 - 避免生成空字符串

2. **放宽过滤** 
 - 多样性阈值：30% → 20%
 - 允许更多正常代码通过

3. **温和采样** 
 - do_sample=True
 - temperature=0.3
 - 减少重复字符生成

4. **数据质量** 
 - 修复PyTorch函数简化的bug
 - 确保生成的训练数据正确

---

## 核心逻辑

```
规则引导生成流程：
┌────────────────────┐
│ 匹配到规则 │
└─────────┬──────────┘
 ↓
┌────────────────────┐
│ 1. 尝试直接应用 │ ← 优先
└─────────┬──────────┘
 ↓
 成功? 
 ↓ 否
┌────────────────────┐
│ 2. 简化LLM prompt │ ← Fallback
└─────────┬──────────┘
 ↓
 有效?
 ↓ 否
┌────────────────────┐
│ 3. 返回原代码 │ ← 最终保底
└────────────────────┘
```

---

## 修改文件清单

```bash
# 必须上传的修复文件
server_scripts/hybrid_generator.py # 核心修复
server_scripts/fetch_public_dataset.py # 数据bug修复
server_scripts/test_rule_guided.py # 测试脚本（新）

# 已有文件（需确保最新）
server_scripts/rule_learner.py
server_scripts/rule_matcher.py
server_scripts/run_hybrid_system_fixed.py
```

---

## 验证清单

- [ ] `fetch_public_dataset.py`生成数据无错误
- [ ] `test_rule_guided.py`测试通过
- [ ] 规则引导策略不再生成空字符串
- [ ] 精确匹配率提升到40%+
- [ ] 规则引导准确率达到40-60%
