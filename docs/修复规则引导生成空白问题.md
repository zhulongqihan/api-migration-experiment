# ä¿®å¤è§„åˆ™å¼•å¯¼ç”Ÿæˆç©ºç™½é—®é¢˜

## ğŸ› é—®é¢˜æè¿°

è¿è¡Œæ··åˆç³»ç»Ÿæ—¶ï¼Œ**è§„åˆ™å¼•å¯¼Promptç­–ç•¥32æ¬¡å…¨éƒ¨ç”Ÿæˆç©ºå­—ç¬¦ä¸²**ï¼š

```
ç­–ç•¥æ•ˆæœåˆ†æï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”“
â”ƒ ç­–ç•¥           â”ƒ ä½¿ç”¨æ¬¡æ•° â”ƒ æ­£ç¡®æ¬¡æ•° â”ƒ å‡†ç¡®ç‡ â”ƒ
â”¡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”©
â”‚ è§„åˆ™ç›´æ¥åº”ç”¨   â”‚ 18       â”‚ 9        â”‚ 50.0%  â”‚
â”‚ è§„åˆ™å¼•å¯¼Prompt â”‚ 32       â”‚ 0        â”‚ 0.0%   â”‚  â† å…¨éƒ¨å¤±è´¥ï¼
â”‚ LLMå…œåº•        â”‚ 1        â”‚ 0        â”‚ 0.0%   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤±è´¥æ¡ˆä¾‹ï¼š
  æ—§ä»£ç : input.cuda()
  ç”Ÿæˆ: ï¼ˆç©ºï¼‰
  æœŸæœ›: input.to('cuda')
  ç­–ç•¥: rule_guided
```

---

## ğŸ” æ ¹æœ¬åŸå› 

### åŸå› 1ï¼šFallbacké€»è¾‘é”™è¯¯
```python
# âŒ æ—§ä»£ç ï¼ˆé”™è¯¯ï¼‰
def _generate_with_rule_guidance(self, old_code, rule, description):
    # è¯•å›¾åˆ›å»ºæ–°çš„RuleMatcher â†’ å¤±è´¥
    try:
        from rule_matcher import RuleMatcher
        matcher = RuleMatcher([rule], confidence_threshold=0.5)
        direct_result = matcher.apply_rules(old_code, [(rule, 1.0)])
        ...
    except:
        pass  # é™é»˜å¤±è´¥
```

### åŸå› 2ï¼šLLMç”Ÿæˆé‡å¤å­—ç¬¦åè¢«è¿‡åº¦è¿‡æ»¤
```python
# âŒ æ—§ä»£ç ï¼ˆè¿‡ä¸¥ï¼‰
if diversity < 0.3:  # 30%çš„é˜ˆå€¼å¤ªé«˜
    console.print(f"æ£€æµ‹åˆ°ä½å¤šæ ·æ€§è¾“å‡ºï¼Œè·³è¿‡: {line}")
    continue

# æœ€åè¿”å›ç©ºå­—ç¬¦ä¸²
return ""  # â† å¯¼è‡´è§„åˆ™å¼•å¯¼å¤±è´¥
```

### åŸå› 3ï¼šæ•°æ®ç”Ÿæˆè„šæœ¬bug
```python
# âŒ æ—§ä»£ç ï¼ˆé”™è¯¯ï¼‰
func_patterns = [
    ("sigmoid", "sigmoid"),  # å…ƒç»„
    ...
]
for func in func_patterns:
    f"torch.nn.functional.{func}(x)"  # æ’å…¥å…ƒç»„ï¼
    # ç”Ÿæˆ: torch.nn.functional.('sigmoid', 'sigmoid')(x)
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤1ï¼šæ”¹è¿›è§„åˆ™å¼•å¯¼é€»è¾‘

**æ–‡ä»¶**: `server_scripts/hybrid_generator.py`

```python
# âœ… æ–°ä»£ç ï¼ˆæ­£ç¡®ï¼‰
def _generate_with_rule_guidance(self, old_code, rule, description):
    """å…ˆå°è¯•ç›´æ¥åº”ç”¨è§„åˆ™ï¼Œå¤±è´¥åˆ™ç”¨LLMï¼Œæœ€åè¿”å›åŸä»£ç """
    
    # 1. å…ˆç”¨å½“å‰matcherç›´æ¥åº”ç”¨è§„åˆ™
    try:
        direct_result = self.matcher.apply_rules(old_code, [(rule, 1.0)])
        if direct_result and direct_result != old_code:
            return direct_result
    except Exception as e:
        console.print(f"[dim]è§„åˆ™åº”ç”¨å¤±è´¥: {e}[/dim]")
    
    # 2. è§„åˆ™æ— æ³•åº”ç”¨ï¼Œä½¿ç”¨ç®€åŒ–çš„LLM prompt
    if rule['type'] == 'api_replacement':
        prompt = f"""{old_code}
Replace {rule['old_api']} with {rule['new_api']}:"""
    else:
        # å‚æ•°è¿ç§»ç­‰å¤æ‚ç±»å‹ç›´æ¥è¿”å›åŸä»£ç 
        return old_code
    
    # 3. LLMç”Ÿæˆ
    generated = self._llm_generate(prompt, max_new_tokens=50)
    
    # 4. å¦‚æœç”Ÿæˆå¤±è´¥ï¼Œè¿”å›åŸä»£ç ï¼ˆè€Œä¸æ˜¯ç©ºå­—ç¬¦ä¸²ï¼‰
    if not generated or generated.strip() == "":
        return old_code
    
    return generated
```

---

### ä¿®å¤2ï¼šæ”¾å®½LLMç”Ÿæˆçš„å¤šæ ·æ€§æ£€æµ‹

**æ–‡ä»¶**: `server_scripts/hybrid_generator.py`

```python
# âœ… æ–°ä»£ç ï¼ˆæ”¾å®½ï¼‰
def _llm_generate(self, prompt, max_new_tokens=80):
    # ä½¿ç”¨æ›´æ¸©å’Œçš„ç”Ÿæˆå‚æ•°
    outputs = self.model.generate(
        **inputs,
        max_new_tokens=max_new_tokens,
        do_sample=True,          # ä½¿ç”¨é‡‡æ ·
        temperature=0.3,         # ä½æ¸©åº¦
        top_p=0.9,
        repetition_penalty=1.2,  # é€‚åº¦é˜²é‡å¤
        no_repeat_ngram_size=3
    )
    
    # åªè¿‡æ»¤æç«¯æƒ…å†µ
    if len(line) > 15:
        diversity = unique_chars / total_chars
        
        # æ”¾å®½åˆ°20%ï¼ˆåŸ30%å¤ªä¸¥ï¼‰
        if diversity < 0.2:
            continue
        
        # è¿‡å¤šç‰¹æ®Šå­—ç¬¦
        if line.count('!') > 5 or line.count('?') > 5:
            continue
    
    # è¿”å›ç”Ÿæˆçš„ä»£ç 
    return code_lines[0] if code_lines else ""
```

---

### ä¿®å¤3ï¼šä¿®æ­£æ•°æ®ç”Ÿæˆè„šæœ¬

**æ–‡ä»¶**: `server_scripts/fetch_public_dataset.py`

```python
# âŒ æ—§ä»£ç 
func_patterns = [("sigmoid", "sigmoid"), ...]
for func in func_patterns:  # funcæ˜¯å…ƒç»„
    f"torch.nn.functional.{func}(x)"  # é”™è¯¯

# âœ… æ–°ä»£ç 
func_names = ["sigmoid", "tanh", "relu", "softmax"]
for func in func_names:  # funcæ˜¯å­—ç¬¦ä¸²
    f"torch.nn.functional.{func}(x)"  # æ­£ç¡®
```

---

## ğŸš€ éªŒè¯ä¿®å¤

### æ­¥éª¤1ï¼šé‡æ–°ç”Ÿæˆæ•°æ®é›†

```bash
cd ~/api_migration_exp/scripts

# é‡æ–°ç”Ÿæˆå…¬å¼€æ•°æ®é›†ï¼ˆä¿®å¤PyTorch bugï¼‰
python3 fetch_public_dataset.py
```

### æ­¥éª¤2ï¼šå¿«é€Ÿæµ‹è¯•

```bash
# æµ‹è¯•è§„åˆ™å¼•å¯¼ç”Ÿæˆæ˜¯å¦æ­£å¸¸
python3 test_rule_guided.py
```

**é¢„æœŸè¾“å‡º**ï¼š
```
æµ‹è¯•è§„åˆ™å¼•å¯¼ç”Ÿæˆ

âœ“ åŠ è½½äº† XX æ¡è§„åˆ™

æµ‹è¯•æ¡ˆä¾‹ï¼š

æ¡ˆä¾‹ 1:
  æ—§ä»£ç : input.cuda()
  æœŸæœ›: input.to('cuda')
  ç”Ÿæˆ: input.to('cuda')
  ç­–ç•¥: rule_direct
  ç½®ä¿¡åº¦: 0.95
  âœ“ ç²¾ç¡®åŒ¹é…

æ¡ˆä¾‹ 2:
  æ—§ä»£ç : df.append(row)
  æœŸæœ›: pd.concat([df, row])
  ç”Ÿæˆ: pd.concat([df, row])
  ç­–ç•¥: rule_direct
  ç½®ä¿¡åº¦: 0.90
  âœ“ ç²¾ç¡®åŒ¹é…
```

### æ­¥éª¤3ï¼šå®Œæ•´è¿è¡Œ

```bash
# åˆ é™¤æ—§è§„åˆ™
rm ../configs/learned_rules.json

# è¿è¡Œå®Œæ•´æ··åˆç³»ç»Ÿ
python3 run_hybrid_system_fixed.py public_dataset.json
```

---

## ğŸ“Š é¢„æœŸæ”¹è¿›

```diff
ä¿®å¤å‰ï¼ˆè§„åˆ™å¼•å¯¼å…¨éƒ¨å¤±è´¥ï¼‰:
- è§„åˆ™å¼•å¯¼Prompt: 32æ¬¡ä½¿ç”¨ï¼Œ0æ¬¡æ­£ç¡®ï¼Œ0.0%å‡†ç¡®ç‡
- ç²¾ç¡®åŒ¹é…ç‡: 17.6%
- å¹³å‡ç›¸ä¼¼åº¦: 0.330

ä¿®å¤åï¼ˆè§„åˆ™å¼•å¯¼æ­£å¸¸å·¥ä½œï¼‰:
+ è§„åˆ™å¼•å¯¼Prompt: åº”è¯¥èƒ½ç”Ÿæˆæœ‰æ•ˆä»£ç 
+ è§„åˆ™å¼•å¯¼å‡†ç¡®ç‡: é¢„æœŸ40-60%
+ ç²¾ç¡®åŒ¹é…ç‡: é¢„æœŸæå‡åˆ°40-55%
+ å¹³å‡ç›¸ä¼¼åº¦: é¢„æœŸæå‡åˆ°0.55-0.70
```

---

## ğŸ”‘ å…³é”®æ”¹è¿›ç‚¹

1. **æ™ºèƒ½Fallback** âœ…
   - è§„åˆ™åº”ç”¨å¤±è´¥ â†’ ç®€åŒ–LLM prompt â†’ è¿”å›åŸä»£ç 
   - é¿å…ç”Ÿæˆç©ºå­—ç¬¦ä¸²

2. **æ”¾å®½è¿‡æ»¤** âœ…
   - å¤šæ ·æ€§é˜ˆå€¼ï¼š30% â†’ 20%
   - å…è®¸æ›´å¤šæ­£å¸¸ä»£ç é€šè¿‡

3. **æ¸©å’Œé‡‡æ ·** âœ…
   - do_sample=True
   - temperature=0.3
   - å‡å°‘é‡å¤å­—ç¬¦ç”Ÿæˆ

4. **æ•°æ®è´¨é‡** âœ…
   - ä¿®å¤PyTorchå‡½æ•°ç®€åŒ–çš„bug
   - ç¡®ä¿ç”Ÿæˆçš„è®­ç»ƒæ•°æ®æ­£ç¡®

---

## ğŸ¯ æ ¸å¿ƒé€»è¾‘

```
è§„åˆ™å¼•å¯¼ç”Ÿæˆæµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŒ¹é…åˆ°è§„åˆ™        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å°è¯•ç›´æ¥åº”ç”¨    â”‚ â† ä¼˜å…ˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
       æˆåŠŸ? 
        â†“ å¦
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ç®€åŒ–LLM prompt  â”‚ â† Fallback
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
       æœ‰æ•ˆ?
        â†“ å¦
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è¿”å›åŸä»£ç       â”‚ â† æœ€ç»ˆä¿åº•
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

```bash
# å¿…é¡»ä¸Šä¼ çš„ä¿®å¤æ–‡ä»¶
server_scripts/hybrid_generator.py        # æ ¸å¿ƒä¿®å¤
server_scripts/fetch_public_dataset.py    # æ•°æ®bugä¿®å¤
server_scripts/test_rule_guided.py        # æµ‹è¯•è„šæœ¬ï¼ˆæ–°ï¼‰

# å·²æœ‰æ–‡ä»¶ï¼ˆéœ€ç¡®ä¿æœ€æ–°ï¼‰
server_scripts/rule_learner.py
server_scripts/rule_matcher.py
server_scripts/run_hybrid_system_fixed.py
```

---

## âœ… éªŒè¯æ¸…å•

- [ ] `fetch_public_dataset.py`ç”Ÿæˆæ•°æ®æ— é”™è¯¯
- [ ] `test_rule_guided.py`æµ‹è¯•é€šè¿‡
- [ ] è§„åˆ™å¼•å¯¼ç­–ç•¥ä¸å†ç”Ÿæˆç©ºå­—ç¬¦ä¸²
- [ ] ç²¾ç¡®åŒ¹é…ç‡æå‡åˆ°40%+
- [ ] è§„åˆ™å¼•å¯¼å‡†ç¡®ç‡è¾¾åˆ°40-60%
