# 实验记录

## 📅 初步完成 

### 环境配置（已完成）

**服务器信息**：
- 主机: 3090
- GPU: 2x NVIDIA GeForce RTX 3090 Ti (24GB each)
- CUDA版本: 11.4
- Driver版本: 470.223.02

**软件环境**：
- Python: 3.10.18
- conda: 25.7.0
- 环境名称: apiupdate

**已安装依赖**：
- ✅ PyTorch 2.6.0+cu118
- ✅ Transformers 4.46.0+ (升级以支持Qwen2.5)
- ✅ PEFT 0.7.0
- ✅ Datasets 2.15.0
- ✅ Accelerate 0.30.0+ (重装以兼容numpy 2.x)
- ✅ NumPy 2.2.6 (升级以兼容accelerate)
- ✅ BitsAndBytes 0.41.0
- ✅ libcst, tqdm, rich, wandb, rouge-score

**Day 1 完成事项**：
- ✅ 检查GPU状态（2张3090 Ti，48GB总显存，完全空闲）
- ✅ 创建项目目录结构（~/api_migration_exp）
- ✅ 创建conda环境（apiupdate, Python 3.10.18）
- ✅ 安装PyTorch + CUDA（成功识别2张GPU）
- ✅ 安装所有核心依赖（transformers, peft, datasets等）
- ✅ 创建环境测试脚本（scripts/test_env.py）
- ✅ 保存环境配置（requirements.txt）
- ✅ Git仓库初始化和首次提交

**遇到的问题和解决**：
1. **PyTorch安装问题**：
   - 问题：cu113索引找不到版本
   - 解决：改用cu118索引（向后兼容CUDA 11.4）
   
2. **datasets安装问题**：
   - 问题：pyarrow需要CMake 3.25+，系统是3.10.2
   - 解决：使用conda安装datasets（自动处理依赖）

---

## 📅 阶段2：数据和框架准备（已完成）

**完成事项**：
- ✅ 创建mini_dataset.json（3训练+1测试样例）
- ✅ 实现data_utils.py（数据加载工具，95行）
- ✅ 实现rule_extractor.py（规则提取器，87行）
- ✅ 实现prompt_engineering.py（4种Prompt策略，107行）
- ✅ 实现test_phase2.py（完整测试套件，209行）
- ✅ 生成规则库（configs/rules.json，3条规则）
- ✅ 所有测试通过

**数据集详情**：
- pandas: `append()` → `concat()` (函数替换)
- numpy: `keepdims` 参数变化
- requests: 添加 `timeout` 参数

**测试结果**：
```
✅ 数据加载器: 通过 (3 train, 1 test)
✅ 规则提取器: 3条规则 (pandas/numpy/requests)
✅ Prompt策略: 4种 (230-400字符)
✅ 端到端测试: 全部通过
```

---

## 📅 阶段3.1：方向3 - 规则+Prompt baseline（进行中）

### 任务3.1.1：模型加载测试（已完成）

**目标**：成功加载Qwen2.5-Coder-1.5B模型并测试推理

**遇到的问题和解决**：

1. **SSL证书验证失败**：
   - 问题：`SSL: CERTIFICATE_VERIFY_FAILED - self-signed certificate`
   - 原因：服务器使用自签名证书
   - 尝试：添加SSL禁用代码（无效）
   - 解决：继续尝试其他方案

2. **Qwen2Tokenizer不存在**：
   - 问题：`Tokenizer class Qwen2Tokenizer does not exist`
   - 原因：transformers版本太旧（4.36.0）
   - 解决：升级transformers到4.46.0+

3. **accelerate模块缺失**：
   - 问题：`No module named 'accelerate'`
   - 解决：安装accelerate库

4. **numpy版本冲突**：
   - 问题：`module 'numpy._core' has no attribute 'multiarray'`
   - 原因：accelerate与旧版numpy(1.26.4)不兼容
   - 解决：升级numpy到2.2.6

5. **accelerate导入失败**：
   - 问题：`No module named 'accelerate.hooks'`
   - 原因：numpy升级后，accelerate需要重装
   - 解决：完全卸载并重装transformers和accelerate

**最终解决方案**：
```bash
# 升级numpy
pip install --upgrade numpy  # 1.26.4 → 2.2.6

# 重装transformers和accelerate（在新numpy环境下）
pip uninstall transformers accelerate -y
pip install transformers accelerate
```

**测试结果**：
- ✅ 模型：Qwen/Qwen2.5-Coder-1.5B (1.54B参数)
- ✅ 下载：3.09GB，耗时3分35秒
- ✅ 加载：成功（运行在CPU，CUDA驱动版本太旧）
- ✅ 推理：成功生成代码
- ✅ 代码质量：正确实现`add()`函数

**生成示例**：
```python
# 用Python写一个函数，计算两个数的和
def add(a, b):
    return a + b

print(add(1, 2))
```

**备注**：
- ⚠️ 模型运行在CPU而非GPU（CUDA driver 11040太旧）
- 💡 功能正常，可以继续进行pipeline开发
- 💡 后续如需GPU加速，需要升级CUDA驱动

---

---

### 任务3.1.2：实现完整推理pipeline（已完成）

**目标**：实现Baseline推理系统，测试4种Prompt策略

**完成事项**：
- ✅ 实现inference_baseline.py（229行）
- ✅ 集成data_utils、rule_extractor、prompt_engineering模块
- ✅ 实现4种策略：basic、with_context、with_rules、cot
- ✅ 在测试集上成功运行
- ✅ 生成结果文件和可读摘要

**运行结果**：
```
测试样例: 1
策略数量: 4
总生成数: 4
推理时间: basic(17s), with_context(17s), with_rules(15s), cot(11s)
```

**生成文件**：
- `results/baseline/baseline_results_20251106_062944.json` - 完整结果
- `results/baseline/baseline_summary_20251106_062944.txt` - 可读摘要

**遇到的问题**：
1. **方法名错误**：
   - 问题：CoT策略调用了不存在的方法名
   - 原因：方法名是`cot_prompt`而非`api_update_prompt_cot`
   - 解决：修正方法名，重新运行成功

**技术细节**：
- 模型：Qwen/Qwen2.5-Coder-1.5B
- 设备：CPU（CUDA驱动11.4太旧，无法使用GPU）
- 生成参数：max_tokens=200, temperature=0.7, top_p=0.95
- 规则库：未找到（路径问题），使用空规则继续

**备注**：
- ⚠️ CPU推理速度较慢（每样例10-17秒）
- 💡 GPU加速需要升级CUDA驱动，但不影响当前实验
- 💡 规则库路径需要修正，暂不影响功能验证

---

### 下一步：任务3.1.3 - 评估和分析

**目标**：
- [ ] 分析4种策略生成的代码质量
- [ ] 实现评估指标（BLEU、代码相似度、执行正确率）
- [ ] 对比策略效果
- [ ] 统计失败案例

---

## 重要笔记

### GPU使用记录
- GPU 0: [占用情况]
- GPU 1: [占用情况]

### 模型训练记录
| 日期 | 模型 | 方法 | 训练时间 | 显存占用 | 结果 |
|------|------|------|---------|---------|------|
| - | - | - | - | - | - |

### 数据集统计
- 训练集: X 样例
- 测试集: X 样例
- 数据来源: XXX

---

*持续更新中...*

