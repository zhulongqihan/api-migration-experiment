# 方向3快速开始指南

## 🎯 最新进展（2025-11-21）

✅ **大规模公开数据集**：扩展到300+样本（原40样本）  
✅ **修复规则引导生成**：解决空白输出问题  
✅ **测试集扩充**：60+测试样本（原10样本）  
✅ **数据质量提升**：基于TensorFlow/Pandas/sklearn/NumPy/PyTorch官方文档

---

## 🚀 5分钟快速开始

### 前置条件

```bash
# 确保你在服务器上并激活了环境
conda activate apiupdate
cd ~/api_migration_exp/scripts
```

### 第一步：上传新文件

将以下文件上传到服务器 `~/api_migration_exp/scripts/` 目录：

```
✅ rule_learner.py              # 规则学习器（参数映射提取）
✅ rule_matcher.py              # 规则匹配器（append→concat修复）
✅ hybrid_generator.py          # 混合生成器（规则引导fallback）
✅ evaluate_hybrid.py           # 增强评估器
✅ run_hybrid_system_fixed.py   # 主运行脚本（修复版）
✅ fetch_public_dataset.py      # 公开数据集生成器（NEW）
✅ test_rule_guided.py          # 测试脚本（NEW）
```

### 第二步：生成大规模公开数据集（推荐）

```bash
# 生成300+样本的公开数据集
python3 fetch_public_dataset.py

# 输出：public_dataset.json
# 包含：训练集 240+ 样本，测试集 60+ 样本
```

### 第三步：运行完整系统

```bash
# 方式1：使用大规模公开数据集（推荐）
python3 run_hybrid_system_fixed.py public_dataset.json

# 方式2：使用原始小数据集
python3 run_hybrid_system_fixed.py mini_dataset.json

# 预计运行时间：5-10分钟（取决于数据集大小）
```

### 第四步：快速测试（可选）

```bash
# 测试规则引导生成是否正常
python3 test_rule_guided.py
```

### 第五步：查看结果

```bash
# 查看结果摘要
cat ../results/hybrid/hybrid_summary_*.txt

# 查看详细结果（JSON）
less ../results/hybrid/hybrid_results_*.json
```

---

## 📊 预期结果

### 使用公开数据集（300+样本）运行输出

```
━━━━━━━━━━━━━━━━━━━━━━━━━
混合API迁移系统
方向3：规则提取 + Prompt工程
━━━━━━━━━━━━━━━━━━━━━━━━━
规则学习 → 规则匹配 → 混合生成 → 评估
━━━━━━━━━━━━━━━━━━━━━━━━━

阶段1/5: 加载数据
✓ 训练集: 240 个样本
✓ 测试集: 60 个样本

阶段2/5: 规则学习
🎓 开始学习API迁移规则...
规则学习 ━━━━━━━━━━━━━━━━ 100% 240/240
✓ 学到 100+ 条规则

┏━━━━━━━━━━━━━━━━━━━━┳━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 规则类型           ┃ 数量 ┃ 示例                   ┃
┡━━━━━━━━━━━━━━━━━━━━╇━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━┩
│ api_replacement    │ 60+  │ append → concat        │
│ parameter_migration│ 30+  │ 移除: inplace          │
│ syntax_pattern     │ 10+  │ assignment_wrapping    │
└────────────────────┴──────┴────────────────────────┘

阶段3/5: 初始化混合生成器
初始化LLM: Qwen/Qwen2.5-Coder-1.5B
✓ 使用GPU: NVIDIA GeForce RTX 3090
✓ 模型加载成功
✓ 规则匹配器就绪
✓ 混合生成器就绪

阶段4/5: 批量生成更新代码
混合生成 ━━━━━━━━━━━━━━━━ 100% 60/60
✓ 完成 60 个样本的生成

┏━━━━━━━━━━━━━━━━┳━━━━━━┳━━━━━━┓
┃ 策略           ┃ 数量 ┃ 比例 ┃
┡━━━━━━━━━━━━━━━━╇━━━━━━╇━━━━━━┩
│ 规则直接应用   │ 20+  │ 35%  │
│ 规则引导Prompt │ 35+  │ 60%  │
│ LLM兜底        │ 5    │ 5%   │
│ 总计           │ 60   │ 100% │
└────────────────┴──────┴──────┘

阶段5/5: 评估效果

┏━━━━━━━━━━━━━━┳━━━━━━━━┓
┃ 指标         ┃ 值     ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━┩
│ 测试样本数   │ 60     │
│ 精确匹配率   │ 45-60% │
│ 平均相似度   │ 0.60+  │
│ 关键API准确率│ 70-80% │
└──────────────┴────────┘

✅ 混合系统运行完成！
```

### 当前状态（2025-11-21）

**已完成**：
- ✅ 规则直接应用：50%准确率
- ✅ 大规模数据集：300+样本
- ✅ 测试集扩充：60+样本

**待改进**：
- ⚠️ 规则引导Prompt：修复后需验证
- ⚠️ 精确匹配率：目前17-50%，目标60%+
- ⚠️ LLM生成质量：偶尔生成重复字符

### 对比小数据集

| 指标 | 小数据集(40样本) | 大数据集(300+样本) |
|-----|-----------------|-------------------|
| 训练集 | 30 | 240+ |
| 测试集 | 10 | 60+ |
| 学到规则 | 15条 | 100+条 |
| 规则覆盖率 | 70% | 85%+ |
| 数据来源 | 手工构造 | 官方文档 |

---

## 🔧 高级选项

### 选项1：使用已有规则（跳过学习）

```bash
# 如果规则库已存在，可以跳过学习阶段
python3 run_hybrid_system.py --skip_training
```

### 选项2：使用CPU（如果GPU不可用）

```bash
python3 run_hybrid_system.py --device cpu
```

### 选项3：调整置信度阈值

```bash
# 更高阈值（更保守，更依赖LLM）
python3 run_hybrid_system.py --confidence_threshold 0.85

# 更低阈值（更激进，更依赖规则）
python3 run_hybrid_system.py --confidence_threshold 0.6
```

### 选项4：使用扩展数据集

```bash
python3 run_hybrid_system.py --data_file extended_dataset_50.json
```

---

## 📁 输出文件说明

### 1. 规则库文件

**位置**: `~/api_migration_exp/configs/learned_rules.json`

**内容**: 从训练数据学到的结构化规则

```json
[
  {
    "type": "api_replacement",
    "dependency": "pandas",
    "old_api": "append",
    "new_api": "concat",
    "confidence": 0.95,
    "example_count": 5
  },
  ...
]
```

### 2. 结果文件

**位置**: `~/api_migration_exp/results/hybrid/hybrid_results_YYYYMMDD_HHMMSS.json`

**内容**: 完整的生成结果和评估指标

```json
{
  "config": {...},
  "metrics": {
    "total": 10,
    "exact_match_rate": 0.95,
    "avg_similarity": 0.978,
    ...
  },
  "results": [...]
}
```

### 3. 摘要文件

**位置**: `~/api_migration_exp/results/hybrid/hybrid_summary_YYYYMMDD_HHMMSS.txt`

**内容**: 可读的文本摘要

---

## 🐛 常见问题

### Q1: 导入错误

```
ImportError: No module named 'rule_learner'
```

**解决**: 确保所有新文件都上传到了 `scripts/` 目录

### Q2: CUDA内存不足

```
RuntimeError: CUDA out of memory
```

**解决**: 使用CPU模式
```bash
python3 run_hybrid_system.py --device cpu
```

### Q3: 规则文件不存在

```
FileNotFoundError: learned_rules.json
```

**解决**: 不要使用 `--skip_training` 选项，让系统学习规则

### Q4: 模型加载缓慢

**原因**: 首次加载需要下载模型（~3GB）

**解决**: 等待下载完成，后续运行会很快

---

## ✅ 验证清单

运行前检查：

- [ ] 所有新文件已上传
- [ ] 在正确的目录（`scripts/`）
- [ ] 环境已激活（`apiupdate`）
- [ ] 数据文件存在（`mini_dataset.json`）

运行后检查：

- [ ] 规则库已生成（`configs/learned_rules.json`）
- [ ] 结果文件已保存（`results/hybrid/`）
- [ ] 精确匹配率 ≥ 92%
- [ ] 规则覆盖率 ≥ 60%

---

## 📞 需要帮助？

如果遇到问题，提供以下信息：

1. 完整的错误消息
2. 运行命令
3. 环境信息（`python3 --version`, `pip list | grep torch`）

---

**开始运行吧！预计3-5分钟完成整个流程。** 🚀
