# 方向3深化实现指南：规则提取+Prompt工程

## 📋 研究背景

### 研究框架（严格遵循实验思路）

```
方向1：强化学习/偏好微调（LoRA/DPO）- 延续Recode思路
方向2：神经知识编辑（ROME/MEMIT）- 因果编辑
方向3：规则+Prompt工程 - 结合规则与生成
```

## 前期失败总结

### 方向1：LoRA微调（7次失败❌）

| 尝试 | 配置 | 结果 | 原因 |
|------|------|------|------|
| v1-v3 | 标准LoRA | 梯度NaN | 数值不稳定 |
| v4-v5 | 参数调整 | 损失崩溃 | 过拟合 |
| v6-v7 | FP32训练 | 仍失败 | 数据量不足 |

**根本原因**：
- 40个样本无法支持2M参数的微调
- 梯度信号稀疏（只有关键token有效）
- 小批量导致估计不稳定

### 方向2：ROME编辑（3次失败❌）

| 尝试 | 方法 | 结果 | 原因 |
|------|------|------|------|
| 1 | 简化实现 | 维度错误 | 8960 vs 1536 |
| 2 | EasyEdit | 依赖冲突 | 环境损坏 |
| 3 | 直接实现 | 0/10成功 | 算法复杂 |

**根本原因**：
- 算法复杂度极高（因果追踪+协方差计算）
- 模型架构不匹配（Qwen vs GPT）
- 依赖地狱（库版本冲突）

## 为什么选择深化方向3

### 当前问题

**Baseline现状**：
```python
# 简单调用LLM
prompt = f"Update: {old_code}"
new_code = llm.generate(prompt)
```

**问题**：
- ❌ 无学习过程
- ❌ 不可泛化
- ❌ 黑盒生成
- ❌ 缺乏创新

### 深化方案

**完整系统**：
```
训练数据 → 规则学习 → 规则库
                      ↓
新代码 → 规则匹配 → [有规则] → 规则应用
              ↓
         [无规则] → 规则引导Prompt → LLM生成
```

**优势**：
- ✅ 有学习过程（规则提取）
- ✅ 可泛化（规则迁移）
- ✅ 可解释（规则明确）
- ✅ 高成功率（成熟技术）

## 系统架构

### 三层架构

**Layer 1: 规则学习层**（离线）
```python
训练数据 → AST解析 → 模式提取 → 规则泛化 → 规则库
```

**Layer 2: 规则匹配层**（在线）
```python
新代码 → AST解析 → 规则匹配 → 置信度评分 → 最佳规则
```

**Layer 3: 混合生成层**（在线）
```python
高置信度 → 规则直接应用（100%准确）
中置信度 → 规则引导Prompt（85-90%准确）
低置信度 → 通用Prompt兜底（70-80%准确）
```

### 规则类型

**1. API替换规则**
```json
{
  "type": "api_replacement",
  "old_api": "df.append",
  "new_api": "pd.concat",
  "confidence": 1.0
}
```

**2. 参数迁移规则**
```json
{
  "type": "parameter_migration",
  "func": "concat",
  "param_changes": {
    "inplace": "removed",
    "ignore_index": "added"
  },
  "confidence": 0.9
}
```

**3. 语法模式规则**
```json
{
  "type": "syntax_pattern",
  "old_pattern": "df.append(row)",
  "new_pattern": "df = pd.concat([df, row])",
  "confidence": 0.85
}
```

## 实现计划

### 文件结构

```
server_scripts/
├── rule_learner.py          # 规则学习器（新建）
├── rule_matcher.py          # 规则匹配器（新建）
├── hybrid_generator.py      # 混合生成器（新建）
├── rule_extractor.py        # 原有（增强）
├── prompt_engineering.py    # 原有（增强）
└── evaluate_enhanced.py     # 增强评估（新建）
```

### 实施步骤（3小时）

**阶段1：核心实现（1小时）**
- [ ] `rule_learner.py` - 基础规则提取
- [ ] `rule_matcher.py` - 简单匹配逻辑
- [ ] `hybrid_generator.py` - 混合生成框架

**阶段2：功能增强（1小时）**
- [ ] 规则泛化算法
- [ ] 置信度计算
- [ ] Prompt优化

**阶段3：测试评估（1小时）**
- [ ] 在50个样本上测试
- [ ] 生成规则库
- [ ] 准确率统计

## 评估指标

### 准确率指标
- **Exact Match**: 精确匹配率
- **Code Similarity**: 代码相似度
- **Key API Accuracy**: 关键API准确率

### 规则质量指标（新增）
- **Rule Coverage**: 规则覆盖率（能用规则处理的比例）
- **Rule Precision**: 规则精度（规则应用的准确率）
- **Rule Count**: 学到的规则数量

### 预期结果

```
Pure Baseline: 90% (当前)
Rule-only: 70-75% (规则覆盖有限)
Hybrid (Ours): 92-95% (规则+LLM互补)
```

## 论文贡献

### 核心卖点

1. **完整方法对比**
   - 系统评估三个方向
   - 深入分析失败原因
   - 数据规模影响分析

2. **创新混合架构**
   - 规则学习框架
   - 自适应策略选择
   - 高精度+高覆盖

3. **实用系统设计**
   - 可解释性强
   - 支持增量学习
   - 工业界可用

### 论文结构

```markdown
Title: Learning API Migration Rules: A Hybrid Approach

1. Introduction - 三方向对比
2. Related Work - API迁移研究
3. Methodology
   - 3.1 方向1（失败）
   - 3.2 方向2（失败）
   - 3.3 方向3（成功）✅
4. Experiments - 完整对比+深入分析
5. Discussion - 为什么方向3成功
6. Conclusion - 核心发现+实践建议
```

## 实施时间表

### 今天晚上（2025-11-21 18:00-21:00）

**18:00-19:00**
- [x] 指南文档完成
- [ ] 核心代码实现

**19:00-20:00**
- [ ] 功能完善
- [ ] 集成测试

**20:00-21:00**
- [ ] 实验运行
- [ ] 结果分析

### 明天（2025-11-22）

**上午**: 扩展实验+消融分析
**下午**: 论文大纲+初稿

---

**接下来：立即开始代码实现！** 🚀
