# API版本迁移实验 - 进度记录

## 📅 实验时间线

### 2025年11月5日

#### ✅ 阶段1：环境配置（已完成）

**完成时间**：2025年11月5日

**完成任务**：
- [x] 服务器GPU检查（NVIDIA GeForce RTX 3090, 24GB显存）
- [x] 项目目录创建（~/api_migration_exp）
- [x] conda环境创建（apiupdate, Python 3.10）
- [x] PyTorch安装（CUDA 11.4兼容）
- [x] 核心依赖安装（transformers, peft, datasets, accelerate, bitsandbytes）
- [x] 环境测试通过
- [x] requirements.txt保存

**遇到的问题和解决**：
1. **PyTorch安装问题**：初始使用cu113索引导致版本不匹配
   - 解决：改用cu118索引，向下兼容CUDA 11.4
   
2. **CMake版本问题**：datasets安装时需要CMake 3.25+
   - 解决：使用conda安装datasets，自动解决依赖

3. **网络访问问题**：无法直接访问HuggingFace
   - 计划：使用HF镜像或ModelScope

**环境配置**：
- GPU: NVIDIA GeForce RTX 3090 (24GB)
- CUDA: 11.4
- Python: 3.10
- PyTorch: 2.x+cu118
- 核心库: transformers 4.36.0, peft 0.7.0, datasets (conda), accelerate 0.25.0

---

#### ✅ 阶段2：数据和框架准备（已完成）

**完成时间**：2025年11月5日

**完成任务**：
- [x] Python脚本上传（5个文件：data_utils.py, rule_extractor.py, prompt_engineering.py, test_phase2.py, mini_dataset.json）
- [x] 数据集创建（3个训练样例，1个测试样例）
- [x] 数据加载工具实现并测试
- [x] 规则提取框架实现并测试
- [x] Prompt模板设计（4种策略）
- [x] 端到端流程验证
- [x] 规则库保存

**测试结果**：
```
============================================================
🎉 阶段2所有测试通过！
============================================================

✅ 已完成:
  ✓ 数据集加载 (3 train, 1 test)
  ✓ 规则提取 (3 条规则)
  ✓ Prompt模板 (4 种策略)
  ✓ 端到端流程验证
  ✓ 规则库保存

📂 生成的文件:
  - data/processed/mini_dataset.json
  - configs/rules.json (572 字节)
```

**数据集详情**：
- 训练集：3个样例
  - pandas: append → concat（函数替换）
  - numpy: keepdims参数变化
  - requests: timeout参数添加
- 测试集：1个样例（pandas）

**规则库统计**：
- pandas: 1条规则（function_replacement）
- numpy: 1条规则（parameter_change）
- requests: 1条规则（parameter_add）

**Prompt策略**：
1. 基础Prompt（230字符）
2. 上下文Prompt（270字符）- 包含版本信息
3. 规则引导Prompt（302字符）- 基于提取的规则
4. CoT Prompt（400字符）- 思维链推理

**遇到的问题和解决**：
1. **test_phase2.py路径错误**：
   - 问题：脚本使用相对路径`data/processed/`而非`../data/processed/`
   - 解决：修正为`../data/processed/mini_dataset.json`

**关键成果**：
- ✅ 建立了完整的数据处理管道
- ✅ 实现了规则提取框架
- ✅ 设计了4种Prompt策略
- ✅ 验证了端到端流程可行性

---

## 📊 当前状态

### 已完成阶段
- ✅ **阶段1**：环境配置（100%）
- ✅ **阶段2**：数据和框架准备（100%）

### 进行中
- ⏳ **阶段3**：方法实现（待开始）
  - 方案A：解决网络问题，加载模型
  - 方案B：实现纯规则匹配baseline（不需要模型）
  - 方案C：扩展数据集

### 待完成
- ⏳ 阶段3：实验运行
- ⏳ 阶段4：结果评估

---

## 📝 技术笔记

### 服务器配置
```
位置: ~/api_migration_exp
conda环境: apiupdate (Python 3.10)
GPU: NVIDIA GeForce RTX 3090 (24GB)
CUDA: 11.4
```

### 项目结构
```
~/api_migration_exp/
├── data/
│   └── processed/
│       └── mini_dataset.json         # 数据集
├── scripts/
│   ├── data_utils.py                 # 数据加载工具
│   ├── rule_extractor.py             # 规则提取器
│   ├── prompt_engineering.py         # Prompt模板
│   ├── test_phase2.py                # 阶段2测试
│   └── mini_dataset.json             # 数据源
├── configs/
│   └── rules.json                    # 规则库 (572字节)
├── requirements.txt                  # Python依赖
└── logs/                             # 日志目录
```

### 核心文件说明
1. **data_utils.py** (95行)：数据加载和处理
2. **rule_extractor.py** (87行)：从代码对中提取API更新规则
3. **prompt_engineering.py** (107行)：4种Prompt生成策略
4. **test_phase2.py** (209行)：完整的阶段2测试套件

---

## 🎯 下一步计划

### 选项1：继续阶段3（需要模型）
- 解决网络访问问题（HF镜像/ModelScope）
- 测试小型模型加载（starcoderbase-1b）
- 实现baseline方法

### 选项2：纯规则方法（不需要模型）
- 扩展规则库
- 实现规则匹配引擎
- 在测试集上验证

### 选项3：数据扩展
- 增加更多API更新样例
- 覆盖更多Python库
- 增强规则多样性

---

## 💡 经验总结

### 成功经验
1. **环境隔离**：使用conda独立环境避免了依赖冲突
2. **分阶段验证**：每个阶段都有独立的测试脚本
3. **无网络设计**：阶段2不依赖外部网络，提高了可靠性
4. **模块化设计**：数据、规则、Prompt各自独立，易于测试

### 待改进
1. **网络访问**：需要配置HF镜像或替代方案
2. **数据规模**：当前只有3+1样例，需扩展
3. **规则复杂度**：当前规则较简单，可增加AST分析

---

**最后更新**：2025年11月5日
**下次更新**：完成阶段3后

