# API版本迁移实验 - 进度记录

## 📅 实验时间线

### 2025年11月5日

#### ✅ 阶段1：环境配置（已完成）

**完成时间**：2025年11月5日

**完成任务**：
- [x] 服务器GPU检查（NVIDIA GeForce RTX 3090, 24GB显存）
- [x] 项目目录创建（~/api_migration_exp）
- [x] conda环境创建（apiupdate, Python 3.10）
- [x] PyTorch安装（CUDA 11.4兼容）
- [x] 核心依赖安装（transformers, peft, datasets, accelerate, bitsandbytes）
- [x] 环境测试通过
- [x] requirements.txt保存

**遇到的问题和解决**：
1. **PyTorch安装问题**：初始使用cu113索引导致版本不匹配
   - 解决：改用cu118索引，向下兼容CUDA 11.4
   
2. **CMake版本问题**：datasets安装时需要CMake 3.25+
   - 解决：使用conda安装datasets，自动解决依赖

3. **网络访问问题**：无法直接访问HuggingFace
   - 计划：使用HF镜像或ModelScope

**环境配置**：
- GPU: NVIDIA GeForce RTX 3090 (24GB)
- CUDA: 11.4
- Python: 3.10
- PyTorch: 2.x+cu118
- 核心库: transformers 4.36.0, peft 0.7.0, datasets (conda), accelerate 0.25.0

---

#### ✅ 阶段2：数据和框架准备（已完成）

**完成时间**：2025年11月5日

**完成任务**：
- [x] Python脚本上传（5个文件：data_utils.py, rule_extractor.py, prompt_engineering.py, test_phase2.py, mini_dataset.json）
- [x] 数据集创建（3个训练样例，1个测试样例）
- [x] 数据加载工具实现并测试
- [x] 规则提取框架实现并测试
- [x] Prompt模板设计（4种策略）
- [x] 端到端流程验证
- [x] 规则库保存

**测试结果**：
```
============================================================
🎉 阶段2所有测试通过！
============================================================

✅ 已完成:
  ✓ 数据集加载 (3 train, 1 test)
  ✓ 规则提取 (3 条规则)
  ✓ Prompt模板 (4 种策略)
  ✓ 端到端流程验证
  ✓ 规则库保存

📂 生成的文件:
  - data/processed/mini_dataset.json
  - configs/rules.json (572 字节)
```

**数据集详情**：
- 训练集：3个样例
  - pandas: append → concat（函数替换）
  - numpy: keepdims参数变化
  - requests: timeout参数添加
- 测试集：1个样例（pandas）

**规则库统计**：
- pandas: 1条规则（function_replacement）
- numpy: 1条规则（parameter_change）
- requests: 1条规则（parameter_add）

**Prompt策略**：
1. 基础Prompt（230字符）
2. 上下文Prompt（270字符）- 包含版本信息
3. 规则引导Prompt（302字符）- 基于提取的规则
4. CoT Prompt（400字符）- 思维链推理

**遇到的问题和解决**：
1. **test_phase2.py路径错误**：
   - 问题：脚本使用相对路径`data/processed/`而非`../data/processed/`
   - 解决：修正为`../data/processed/mini_dataset.json`

**关键成果**：
- ✅ 建立了完整的数据处理管道
- ✅ 实现了规则提取框架
- ✅ 设计了4种Prompt策略
- ✅ 验证了端到端流程可行性

---

### 2025年11月24-25日

#### 🐛 混合系统数值稳定性修复

**发现的问题**：
- **LLM生成崩溃**：`RuntimeError: probability tensor contains either inf, nan or element < 0`
- **位置**：`torch.multinomial()`采样函数
- **触发条件**：temperature > 0 且 do_sample=True

**根本原因**：
- Qwen2.5-Coder + transformers 4.44 + 特定Prompt
- logits数值过大，softmax变换后溢出
- `repetition_penalty`和`no_repeat_ngram_size`加剧问题

**解决方案**（2025-11-25）：
1. **全面采用greedy解码**：
   - `_llm_generate`默认temperature=0.0
   - greedy分支移除repetition_penalty和no_repeat_ngram_size
   - 采样分支提高最低温度到0.7（但仍会崩溃）
   
2. **策略阈值优化**：
   - 规则直接应用：0.85 → 0.5（扩大覆盖）
   - 规则引导：0.6 → 0.3
   - 增加安全检查：new_code != old_code
   
3. **评估增强**：
   - 新增成功案例展示（前5个）
   - 显示策略和置信度

**修复后性能**（2025-11-24测试，51样本）：
```
精确匹配率: 23.5%
平均相似度: 0.806
关键API准确率: 58.8%

策略效果：
- 规则直接应用: 21次，12次正确，57.1%
- 规则引导Prompt: 29次，0次正确，0.0% ← greedy复制问题
- LLM兜底: 1次，0次正确，0.0%
```

**成功案例**（规则直接应用）：
1. `np.matrix(data)` → `np.array(data)` ✅
2. `torch.nn.functional.sigmoid(input)` → `torch.sigmoid(input)` ✅
3. `np.in1d(arr1, arr2)` → `np.isin(arr1, arr2)` ✅

**失败原因分析**：
- 规则引导：greedy解码直接复制输入，无法真正生成新代码
- LLM兜底：同样的greedy问题
- **核心矛盾**：采样会崩溃，greedy会复制

**预期优化效果**（降低阈值后）：
- 规则直接应用：21次 → 35-40次
- 精确匹配率：23.5% → 35-45%

**技术限制**：
- ⚠️ 当前环境采样模式完全不可用
- ⚠️ 需要升级transformers或更换模型才能解决

---

## 📊 当前状态

### 已完成阶段
- ✅ **阶段1**：环境配置（100%）
- ✅ **阶段2**：数据和框架准备（100%）
- ✅ **阶段3.1**：方向3混合系统（基础版完成）
  - ✅ 规则学习和匹配
  - ✅ 混合生成框架
  - ✅ 大规模数据集（300+样本）
  - ✅ 数值稳定性修复
  - ✅ 策略优化

### 进行中
- ⏳ **阶段3.2**：性能优化和验证
  - 待验证阈值调整效果
  - 探索采样模式替代方案
  - 数据集持续扩展

### 待完成
- ⏳ 方向1：LoRA微调（遇到兼容性问题，暂缓）
- ⏳ 方向2：知识编辑（实现复杂度高，暂缓）
- ⏳ 论文撰写和实验整理

---

## 📝 技术笔记

### 服务器配置
```
位置: ~/api_migration_exp
conda环境: apiupdate (Python 3.10)
GPU: NVIDIA GeForce RTX 3090 (24GB)
CUDA: 11.4
```

### 项目结构
```
~/api_migration_exp/
├── data/
│   └── processed/
│       └── mini_dataset.json         # 数据集
├── scripts/
│   ├── data_utils.py                 # 数据加载工具
│   ├── rule_extractor.py             # 规则提取器
│   ├── prompt_engineering.py         # Prompt模板
│   ├── test_phase2.py                # 阶段2测试
│   └── mini_dataset.json             # 数据源
├── configs/
│   └── rules.json                    # 规则库 (572字节)
├── requirements.txt                  # Python依赖
└── logs/                             # 日志目录
```

### 核心文件说明
1. **data_utils.py** (95行)：数据加载和处理
2. **rule_extractor.py** (87行)：从代码对中提取API更新规则
3. **prompt_engineering.py** (107行)：4种Prompt生成策略
4. **test_phase2.py** (209行)：完整的阶段2测试套件

---

## 🎯 下一步计划

### 选项1：继续阶段3（需要模型）
- 解决网络访问问题（HF镜像/ModelScope）
- 测试小型模型加载（starcoderbase-1b）
- 实现baseline方法

### 选项2：纯规则方法（不需要模型）
- 扩展规则库
- 实现规则匹配引擎
- 在测试集上验证

### 选项3：数据扩展
- 增加更多API更新样例
- 覆盖更多Python库
- 增强规则多样性

---

## 💡 经验总结

### 成功经验
1. **环境隔离**：使用conda独立环境避免了依赖冲突
2. **分阶段验证**：每个阶段都有独立的测试脚本
3. **无网络设计**：阶段2不依赖外部网络，提高了可靠性
4. **模块化设计**：数据、规则、Prompt各自独立，易于测试

### 待改进
1. **网络访问**：需要配置HF镜像或替代方案
2. **数据规模**：当前只有3+1样例，需扩展
3. **规则复杂度**：当前规则较简单，可增加AST分析

---

**最后更新**：2025年11月25日
**下次更新**：验证阈值优化效果后

